# ──────────────────────────────────────────────────────────────────────────────
# 1. Base image: Python 3.11 slim (small footprint)
# ──────────────────────────────────────────────────────────────────────────────
FROM python:3.11-slim

# ──────────────────────────────────────────────────────────────────────────────
# 2. Set an unprivileged user
# ──────────────────────────────────────────────────────────────────────────────
# Create a user “django” with home directory /home/django
RUN adduser --disabled-password --gecos "" django

# ──────────────────────────────────────────────────────────────────────────────
# 3. Set working directory & copy requirements
# ──────────────────────────────────────────────────────────────────────────────
WORKDIR /app

# Copy only deps first for Docker layer caching
COPY requirements.txt /app/

# ──────────────────────────────────────────────────────────────────────────────
# 4. Install system deps + Python deps
# ──────────────────────────────────────────────────────────────────────────────
RUN apt-get update \
    && apt-get install -y --no-install-recommends \
         build-essential \
         libffi-dev \
         libpq-dev \
         git \
    && pip install --upgrade pip \
    && pip install --no-cache-dir -r requirements.txt \
    && apt-get purge -y --auto-remove build-essential \
    && rm -rf /var/lib/apt/lists/*

# ──────────────────────────────────────────────────────────────────────────────
# 5. Copy the rest of the project
# ──────────────────────────────────────────────────────────────────────────────
COPY . /app/

# ──────────────────────────────────────────────────────────────────────────────
# 6. Switch to non-root user
# ──────────────────────────────────────────────────────────────────────────────
USER django

# ──────────────────────────────────────────────────────────────────────────────
# 7. Expose port 
# ──────────────────────────────────────────────────────────────────────────────
EXPOSE 8000

# ──────────────────────────────────────────────────────────────────────────────
# 8. run Gunicorn
# ──────────────────────────────────────────────────────────────────────────────
